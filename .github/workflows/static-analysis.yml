name: Static Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        config-file: ./.github/workflows/codeql-config.yml
    
    - name: Build
      run: |
        sudo apt-get update
        sudo apt-get install -y clang libc++-dev libc++abi-dev
        chmod +x scripts/*.sh
        ./scripts/configure.sh --release
        ./scripts/build.sh
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  clang-tidy:
    name: Clang-Tidy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang clang-tidy libc++-dev libc++abi-dev
    
    - name: Run clang-tidy
      run: |
        chmod +x scripts/*.sh
        ./scripts/configure.sh --release
        find src -name '*.cpp' -o -name '*.h' | xargs clang-tidy -p build

  cppcheck:
    name: Cppcheck
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install cppcheck
      run: sudo apt-get update && sudo apt-get install -y cppcheck
    
    - name: Run Cppcheck
      run: |
        cppcheck --enable=all --inconclusive --xml --xml-version=2 \
          --suppress=missingIncludeSystem \
          --inline-suppr \
          src/ 2> cppcheck-report.xml
    
    - name: Upload Cppcheck results
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-results
        path: cppcheck-report.xml

  codacy:
    name: Codacy Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Codacy Analysis
      uses: codacy/codacy-analysis-cli-action@master
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        upload: true
        format: sarif
      continue-on-error: true
    
    - name: Upload to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif
      continue-on-error: true

  devskim:
    name: DevSkim Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run DevSkim scanner
      uses: microsoft/DevSkim-Action@v1
      with:
        directory-to-scan: src/
    
    - name: Upload DevSkim results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: devskim-results.sarif
      continue-on-error: true

  msft-cpp-analysis:
    name: Microsoft C++ Code Analysis
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Run Microsoft C++ Code Analysis
      run: |
        .\scripts\configure.ps1 -Release
        msbuild build\wshell.sln /p:EnableClangTidyCodeAnalysis=true /p:RunCodeAnalysis=true
      continue-on-error: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high

  defender-devops:
    name: Microsoft Defender for DevOps
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Microsoft Defender for DevOps
      uses: microsoft/security-devops-action@v1
      id: msdo
      continue-on-error: true
    
    - name: Upload results to Security tab
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ steps.msdo.outputs.sarifFile }}
      continue-on-error: true

  osv-scanner:
    name: OSV Scanner
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run OSV Scanner
      uses: google/osv-scanner-action/osv-scanner-action@main
      with:
        scan-args: |-
          --recursive
          --skip-git
          ./
      continue-on-error: true

  trivy:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  psscriptanalyzer:
    name: PSScriptAnalyzer
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Set-PSRepository PSGallery -InstallationPolicy Trusted
        Install-Module PSScriptAnalyzer -Force
    
    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path scripts/*.ps1 -Recurse -ReportSummary
        $results | ConvertTo-Json | Out-File -FilePath psscriptanalyzer-results.json
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: psscriptanalyzer-results
        path: psscriptanalyzer-results.json

  semgrep:
    name: Semgrep
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Semgrep
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/cpp
          p/cwe-top-25
        generateSarif: true
    
    - name: Upload Semgrep results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
      continue-on-error: true

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang libc++-dev libc++abi-dev
    
    - name: Configure and Build
      run: |
        chmod +x scripts/*.sh
        # Use Clang with source-based coverage
        cmake -S . -B build \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++ -fPIC -fprofile-instr-generate -fcoverage-mapping" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi -fprofile-instr-generate" \
          -DCMAKE_SHARED_LINKER_FLAGS="-stdlib=libc++ -lc++abi -fprofile-instr-generate" \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_TESTING=ON
        cmake --build build --parallel $(nproc)
    
    - name: Run tests with coverage
      run: |
        cd build
        LLVM_PROFILE_FILE="wshell-%p.profraw" ctest --output-on-failure
    
    - name: Generate coverage
      run: |
        cd build
        llvm-profdata merge -sparse *.profraw -o wshell.profdata
        llvm-cov export ./test/wshell_tests \
          -instr-profile=wshell.profdata \
          -format=lcov \
          -ignore-filename-regex='.*/(test|_deps)/.*' \
          > coverage.info
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=wsollers_shell
          -Dsonar.organization=wsollers
          -Dsonar.sources=src
          -Dsonar.tests=test
          -Dsonar.cfamily.compile-commands=build/compile_commands.json
          -Dsonar.coverageReportPaths=build/coverage.info
      continue-on-error: true