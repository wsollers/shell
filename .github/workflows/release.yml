---
name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [created]

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Create Release
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/}

        # Create release using GitHub CLI
        gh release create "$VERSION" \
          --title "Release $VERSION" \
          --notes-from-tag \
          --draft=false \
          --prerelease=false

  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-24.04
    needs: create-release

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        # Install LLVM/Clang repository for latest packages
        wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
        echo "deb https://apt.llvm.org/noble/ llvm-toolchain-noble-18 main" | sudo tee /etc/apt/sources.list.d/llvm.list
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          clang++-18 \
          libc++-18-dev \
          libc++abi-18-dev \
          cmake
        # Ensure clang-18 can find libc++ headers
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

    - name: Configure and Build
      run: |
        cmake --preset linux-release
        cmake --build build/linux-release --parallel --config Release

    - name: Run Tests
      run: |
        cd build/linux-release
        ctest --output-on-failure --parallel

    - name: Package
      run: |
        cd build/linux-release
        cpack -C Release

    - name: Generate SBOM
      run: |
        # Install Syft
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        
        VERSION=${GITHUB_REF#refs/tags/}
        
        # Generate SBOM for the built binaries
        syft scan dir:build/linux-release -o spdx-json=wshell-$VERSION-linux-sbom.spdx.json
        syft scan dir:build/linux-release -o spdx-tag-value=wshell-$VERSION-linux-sbom.spdx

    - name: Upload Linux Binary and SBOM to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION=${GITHUB_REF#refs/tags/}

        # Find the generated package
        PACKAGE_FILE=$(find build/linux-release -name "wshell-*-Linux.tar.gz" | head -1)
        if [ -n "$PACKAGE_FILE" ]; then
          cp "$PACKAGE_FILE" "wshell-$VERSION-linux-x64.tar.gz"
          gh release upload "$VERSION" "wshell-$VERSION-linux-x64.tar.gz"
        fi
        
        # Upload SBOM files
        gh release upload "$VERSION" "wshell-$VERSION-linux-sbom.spdx.json"
        gh release upload "$VERSION" "wshell-$VERSION-linux-sbom.spdx"

  build-macos:
    name: Build macOS Release
    runs-on: macos-latest
    needs: create-release

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        brew install cmake llvm

    - name: Configure CMake
      run: |
        export PATH="/usr/local/opt/llvm/bin:$PATH"
        cmake --preset macos-release

    - name: Build
      run: |
        cmake --build build/macos-release --parallel --config Release

    - name: Run Tests
      run: |
        cd build/macos-release
        ctest --output-on-failure --parallel

    - name: Package
      run: |
        cd build/macos-release
        cpack -C Release

    - name: Upload macOS Binary to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION=${GITHUB_REF#refs/tags/}

        # Find the generated package
        PACKAGE_FILE=$(find build/macos-release -name "wshell-*-Darwin.tar.gz" | head -1)
        if [ -n "$PACKAGE_FILE" ]; then
          cp "$PACKAGE_FILE" "wshell-$VERSION-macos-x64.tar.gz"
          gh release upload "$VERSION" "wshell-$VERSION-macos-x64.tar.gz"
        fi

  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    needs: create-release

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25'

    - name: Configure CMake
      run: |
        cmake --preset windows-msvc-release

    - name: Build
      run: |
        cmake --build build/windows-msvc-release --parallel --config Release

    - name: Run Tests
      run: |
        cd build/windows-msvc-release
        ctest --output-on-failure --parallel -C Release

    - name: Package
      run: |
        cd build/windows-msvc-release
        cpack -C Release

    - name: Upload Windows Binary to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $VERSION = $env:GITHUB_REF -replace '^refs/tags/', ''

        # Find the generated package
        $PACKAGE_FILE = Get-ChildItem -Path "build/windows-msvc-release" -Name "wshell-*-win64.zip" | Select-Object -First 1
        if ($PACKAGE_FILE) {
          Copy-Item "build/windows-msvc-release/$PACKAGE_FILE" "wshell-$VERSION-windows-x64.zip"
          gh release upload "$VERSION" "wshell-$VERSION-windows-x64.zip"
        }
