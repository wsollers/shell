name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Debug, Release]

    steps:
      - uses: actions/checkout@v4

      # ---------- Dependencies ----------
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libc++-dev libc++abi-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install llvm

      # ---------- Configure ----------
      - name: Configure (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/*.sh
          ./scripts/configure.sh --${{ matrix.build_type == 'Debug' && 'debug' || 'release' }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\configure.ps1 -${{ matrix.build_type }}

      # ---------- Build ----------
      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/build.sh

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\build.ps1

      # ---------- Test ----------
      - name: Test (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/test.sh

      - name: Test (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\test.ps1


  coverage:
    name: Code Coverage (Clang + llvm-cov)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- Dependencies ----------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm libc++-dev libc++abi-dev

      # ---------- Configure with coverage ----------
      - name: Configure (coverage)
        run: |
          chmod +x scripts/*.sh
          ./scripts/configure.sh --coverage --build-dir build

      # ---------- Build ----------
      - name: Build
        run: ./scripts/build.sh --build-dir build

      # ---------- Generate coverage ----------
      - name: Generate coverage (llvm-profdata + llvm-cov)
        run: ./scripts/coverage.sh --build-dir build

      # ---------- Upload ----------
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: wsollers/shell
          files: ./build/coverage.info
