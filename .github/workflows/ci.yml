name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: Build and Test
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - name: "Linux Release (Clang + libc++)"
            os: ubuntu-24.04
            preset: "linux-release"
            build_type: "Release"
          - name: "Linux Debug (Clang + libc++)"
            os: ubuntu-24.04  
            preset: "linux-debug"
            build_type: "Debug"
            
          # macOS builds
          - name: "macOS Release (Clang + libc++)"
            os: macos-14
            preset: "macos-release"
            build_type: "Release"
          - name: "macOS Debug (Clang + libc++)"
            os: macos-14
            preset: "macos-debug" 
            build_type: "Debug"
            
          # Windows builds
          - name: "Windows Release (MSVC)"
            os: windows-2022
            preset: "windows-msvc-release"
            build_type: "Release"
          - name: "Windows Debug (MSVC)"
            os: windows-2022
            preset: "windows-msvc-debug"
            build_type: "Debug"
            
    runs-on: ${{ matrix.os }}
            
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      shell: bash
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y \
            clang-18 \
            libc++-18-dev \
            libc++abi-18-dev \
            cmake \
            lcov
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          # macOS has clang pre-installed, just ensure we have latest cmake
          brew install cmake
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          # Windows uses MSVC, which comes with Visual Studio
          echo "Using pre-installed MSVC on Windows"
        fi
          
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.25'
        
    - name: Configure CMake
      shell: bash
      run: |
        cmake --preset ${{ matrix.preset }}
        
    - name: Build
      shell: bash  
      run: |
        cmake --build build/${{ matrix.preset }} --parallel
        
    - name: Run Tests
      shell: bash
      run: |
        cd build/${{ matrix.preset }}
        ctest --output-on-failure --parallel
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.name }}
        path: build/${{ matrix.preset }}/Testing/

  fuzzing:
    name: Fuzzing Tests
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          libc++-18-dev \
          libc++abi-18-dev \
          cmake
          
    - name: Configure CMake for Fuzzing
      run: |
        cmake --preset linux-fuzz
        
    - name: Build Fuzz Targets
      run: |
        cmake --build build/linux-fuzz --parallel
        
    - name: Run Short Fuzz Tests
      run: |
        cd build/linux-fuzz
        timeout 30s ./fuzz/fuzz_command_parser -max_total_time=25 || true
        timeout 30s ./fuzz/fuzz_shell_core -max_total_time=25 || true

  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          libc++-18-dev \
          libc++abi-18-dev \
          cmake
          
    - name: Configure CMake for Benchmarks
      run: |
        cmake --preset linux-bench
        
    - name: Build Benchmark Targets
      run: |
        cmake --build build/linux-bench --parallel
        
    - name: Run Benchmarks
      run: |
        cd build/linux-bench
        ./bench/bench_command_parser --benchmark_format=json > command_parser_bench.json
        ./bench/bench_shell_core --benchmark_format=json > shell_core_bench.json
        
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: build/linux-bench/*.json

  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          libc++-18-dev \
          libc++abi-18-dev \
          cmake \
          lcov \
          llvm-18
          
    - name: Configure CMake for Coverage
      run: |
        cmake --preset linux-coverage
        
    - name: Build with Coverage
      run: |
        cmake --build build/linux-coverage --parallel
        
    - name: Run Tests with Coverage
      run: |
        cd build/linux-coverage
        # Run tests directly to ensure coverage instrumentation works
        LLVM_PROFILE_FILE="coverage-%p.profraw" ctest --output-on-failure
        # Also try running test binaries directly if ctest doesn't work
        if [ ! -f coverage-*.profraw ]; then
          echo "No coverage files from ctest, trying direct execution..."
          if [ -f test/wshell_tests ]; then
            LLVM_PROFILE_FILE="coverage-%p.profraw" ./test/wshell_tests
          fi
        fi
      env:
        LLVM_PROFILE_FILE: coverage-%p.profraw
        
    - name: Generate Coverage Report (Clang/LLVM)
      run: |
        cd build/linux-coverage
        # Check if we have LLVM coverage data
        echo "Looking for coverage files..."
        find . -name "*.prof*" -type f || true
        
        if find . -name "*.profraw" -type f | grep -q .; then
          echo "Using LLVM coverage (Clang)"
          # Merge profile data
          llvm-profdata-18 merge -sparse *.profraw -o coverage.profdata
          # Find the main executable or test binary to analyze
          TARGET_BINARY=""
          if [ -f "./test/wshell_tests" ]; then
            TARGET_BINARY="./test/wshell_tests"
          elif [ -f "./src/main/wshell" ]; then
            TARGET_BINARY="./src/main/wshell"
          else
            echo "No suitable binary found for coverage analysis"
            find . -name "wshell*" -type f -executable || true
            ls -la test/ || true
            ls -la src/main/ || true
          fi
          
          if [ -n "$TARGET_BINARY" ]; then
            # Generate coverage report
            llvm-cov-18 export --format=lcov --instr-profile=coverage.profdata "$TARGET_BINARY" > coverage.info
            # Filter out system headers and dependencies
            lcov --remove coverage.info '/usr/*' '_deps/*' --output-file coverage_filtered.info
          else
            echo "Creating empty coverage report due to missing target binary"
            touch coverage_filtered.info
          fi
        elif find . -name "*.gcda" -type f | grep -q .; then
          echo "Using GCC coverage (gcov)"
          # Generate coverage with lcov
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '_deps/*' --output-file coverage_filtered.info
        else
          echo "No coverage data found. Creating empty report."
          touch coverage_filtered.info
        fi
        
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: build/linux-coverage/coverage_filtered.info
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false
        verbose: true

  security:
    name: Security Analysis  
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-18 \
          libc++-18-dev \
          libc++abi-18-dev \
          cmake
          
    - name: Configure with Debug (closest to sanitizers)
      run: |
        cmake --preset linux-debug
        
    - name: Build Debug
      run: |
        cmake --build build/linux-debug --parallel
        
    - name: Run Tests in Debug Mode
      run: |
        cd build/linux-debug
        ctest --output-on-failure