name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Debug, Release]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang libc++-dev libc++abi-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install llvm

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/*.sh
          ./scripts/configure.sh --${{ matrix.build_type == 'Debug' && 'debug' || 'release' }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\configure.ps1 -${{ matrix.build_type }}

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/build.sh

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\build.ps1

      - name: Test (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/test.sh

      - name: Test (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\test.ps1


  coverage:
    name: Code Coverage (Clang + llvm-cov)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm libc++-dev libc++abi-dev

      - name: Configure (coverage)
        run: |
          chmod +x scripts/*.sh
          ./scripts/configure.sh --coverage --build-dir build

      - name: Build
        run: ./scripts/build.sh --build-dir build

      # Explicit test step for coverage generation
      - name: Test (generate .profraw)
        run: |
          set -euxo pipefail
          cd build
          mkdir -p coverage
          # Use an ABSOLUTE path so profraw always lands in build/coverage/
          LLVM_PROFILE_FILE="$PWD/coverage/wshell-%p-%m.profraw" \
            ctest --output-on-failure --verbose

          ls -la coverage || true
          ls -la coverage/*.profraw

      - name: Generate coverage (llvm-profdata + llvm-cov)
        run: |
          set -euxo pipefail
          cd build

          llvm-profdata merge -sparse coverage/*.profraw -o coverage/wshell.profdata

          # Export LCOV from the test binary; also include the shared lib object if present
          TEST_BIN="$(find . -type f -name wshell_tests -perm -111 | head -n 1)"
          LIB_OBJ="$(find . -type f \( -name 'libwshell*.so' -o -name 'libwshell*.dylib' \) | head -n 1 || true)"

          if [[ -n "${LIB_OBJ}" ]]; then
            llvm-cov export "${TEST_BIN}" \
              -object "${LIB_OBJ}" \
              -instr-profile=coverage/wshell.profdata \
              -format=lcov \
              -ignore-filename-regex='.*/(test|_deps)/.*' \
              > coverage.info
          else
            llvm-cov export "${TEST_BIN}" \
              -instr-profile=coverage/wshell.profdata \
              -format=lcov \
              -ignore-filename-regex='.*/(test|_deps)/.*' \
              > coverage.info
          fi

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: wsollers/shell
          files: ./build/coverage.info
